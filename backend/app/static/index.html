<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>VEGA | ISRO Console</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base Theme */
        body {
            background-color: #0d0d12;
            color: #e2e2e2;
            display: none;
        }

        .isro-purple {
            background-color: #6d28d9;
        }

        .isro-border {
            border-color: #facc15;
        }

        .tab-active {
            border-bottom: 2px solid #facc15;
            color: #facc15;
        }

        .tab-inactive {
            color: #6b7280;
        }

        .terminal {
            background: #000;
            font-family: 'Courier New', monospace;
            color: #0f0;
            max-height: 200px;
            overflow-y: auto;
        }

        #loader {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #facc15;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>

<body class="p-8">
    <div id="loader">
        <div class="text-center">
            <h2 class="text-2xl font-bold">INITIALIZING VEGA SYSTEM...</h2>
            <p class="text-sm text-gray-500 mt-2">Connecting to Satellite Uplink</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto border-l-4 isro-border pl-6">
        <header class="mb-8 flex flex-col md:flex-row justify-between md:items-center">
            <div class="mb-4 md:mb-0">
                <h1 class="text-4xl font-bold text-yellow-400 tracking-wider">VEGA CONSOLE</h1>
                <p class="text-gray-400 text-sm">AI-Based Satellite Image Terrain Classification</p>
            </div>
            <div class="space-x-6 text-sm font-mono tracking-wide">
                <button onclick="switchTab('predict')" id="tab-predict"
                    class="tab-active pb-1 transition-colors">PREDICTION</button>
                <button onclick="switchTab('change')" id="tab-change"
                    class="tab-inactive pb-1 transition-colors hover:text-white">CHANGE DETECTION</button>
                <button onclick="switchTab('training')" id="tab-training"
                    class="tab-inactive pb-1 transition-colors hover:text-white">TRAINING</button>
                <button onclick="switchTab('analysis')" id="tab-analysis"
                    class="tab-inactive pb-1 transition-colors hover:text-white">ANALYSIS</button>
            </div>
        </header>

        <!-- === PREDICTION VIEW === -->
        <div id="view-predict">
            <section class="bg-gray-900 p-6 rounded-lg border border-gray-800 shadow-lg">
                <h2 class="text-xl mb-4 text-purple-400 font-mono">>_ Upload Satellite Patch(es)</h2>
                <input type="file" id="imageInput" multiple
                    class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer" />
                <button onclick="processUpload()"
                    class="mt-4 px-6 py-2 isro-purple text-white rounded font-bold hover:bg-purple-800 transition shadow-lg shadow-purple-900/50">ANALYZE
                    TERRAIN(S)</button>
            </section>
            <!-- Results -->
            <section id="singleResult" class="mt-8 hidden animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-black p-6 rounded border border-gray-700 relative overflow-hidden">
                        <div
                            class="absolute top-0 right-0 p-2 opacity-20 text-6xl text-white font-bold pointer-events-none">
                            CLASS</div>
                        <h3 class="text-yellow-500 font-bold mb-2 uppercase text-xs tracking-widest">Primary
                            Classification</h3>
                        <div id="mainLabel" class="text-4xl font-bold text-white mb-2">---</div>
                        <div id="confidence" class="text-purple-400 italic">---</div>
                    </div>
                    <div class="bg-black p-6 rounded border border-gray-700">
                        <h3 class="text-gray-500 mb-4 uppercase text-xs tracking-widest">Confidence Metrics</h3>
                        <div id="distribution" class="space-y-3 font-mono text-sm"></div>
                    </div>
                </div>
            </section>
            <section id="batchResult" class="mt-8 hidden animate-fade-in">
                <div class="bg-black p-6 rounded border border-gray-700">
                    <h3 class="text-yellow-500 font-bold mb-6 uppercase tracking-widest">Batch Processing Summary</h3>
                    <p class="text-3xl font-bold text-white mb-6" id="batchTotal">0 Images Processed</p>
                    <div id="batchStats" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
                </div>
            </section>
        </div>

        <!-- === CHANGE DETECTION VIEW === -->
        <div id="view-change" class="hidden">
            <section class="bg-gray-900 p-6 rounded-lg border border-gray-800 shadow-lg">
                <h2 class="text-xl mb-4 text-purple-400 font-mono">>_ Temporal Analysis (Year 1 vs Year 2)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="bg-black p-4 rounded border border-gray-800">
                        <label class="block text-gray-500 text-xs mb-2 font-bold">EPOCH 1 (YEAR 1)</label>
                        <input type="file" id="file1" class="w-full text-xs text-gray-400" />
                    </div>
                    <div class="bg-black p-4 rounded border border-gray-800">
                        <label class="block text-gray-500 text-xs mb-2 font-bold">EPOCH 2 (YEAR 2)</label>
                        <input type="file" id="file2" class="w-full text-xs text-gray-400" />
                    </div>
                </div>
                <button onclick="processChangeDetection()"
                    class="px-6 py-2 bg-yellow-600 text-white rounded font-bold hover:bg-yellow-700 transition shadow-lg shadow-yellow-900/50">COMPARE
                    EPOCHS</button>
            </section>
            <section id="changeResult" class="mt-8 hidden">
                <div class="bg-black p-6 rounded border border-gray-700">
                    <h3 class="text-yellow-500 font-bold mb-4 uppercase tracking-widest">Impact Assessment Report</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left font-mono text-sm">
                            <thead>
                                <tr class="border-b border-gray-800 text-gray-500 uppercase text-xs">
                                    <th class="p-3">Terrain Class</th>
                                    <th class="p-3">Year 1 (km²)</th>
                                    <th class="p-3">Year 2 (km²)</th>
                                    <th class="p-3">Net Change</th>
                                </tr>
                            </thead>
                            <tbody id="changeTableBody" class="text-gray-300"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- === TRAINING VIEW === -->
        <div id="view-training" class="hidden">
            <section class="bg-gray-900 p-6 rounded-lg border border-gray-800 mb-6 flex justify-between items-center">
                <h2 class="text-xl text-purple-400 font-mono">>_ Model Training Dashboard</h2>
                <button onclick="startTraining()" id="trainBtn"
                    class="px-6 py-2 bg-green-700 text-white rounded font-bold hover:bg-green-800 transition text-sm">INITIALIZE
                    TRAINING RUN</button>
            </section>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-black p-4 rounded border border-gray-700"><canvas id="accChart" height="200"></canvas>
                </div>
                <div class="bg-black p-4 rounded border border-gray-700"><canvas id="lossChart" height="200"></canvas>
                </div>
            </div>
            <div class="bg-black p-4 rounded border border-gray-700">
                <div class="flex justify-between mb-2 items-center border-b border-gray-800 pb-2">
                    <h3 class="text-gray-500 text-xs uppercase">System Logs</h3><span id="gpuStatus"
                        class="text-xs text-yellow-500 font-mono animate-pulse">GPU: IDLE</span>
                </div>
                <div id="trainingLogs" class="terminal p-2 text-xs h-40"></div>
            </div>
        </div>

        <!-- === ANALYSIS VIEW (NEW) === -->
        <div id="view-analysis" class="hidden">
            <!-- Leaderboard -->
            <section class="bg-gray-900 p-6 rounded-lg border border-gray-800 mb-6 shadow-lg">
                <h2 class="text-xl mb-4 text-purple-400 font-mono">>_ Model Performance Leaderboard</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left font-mono text-sm">
                        <thead>
                            <tr class="border-b border-gray-800 text-gray-500 uppercase text-xs">
                                <th class="p-3">Model Architecture</th>
                                <th class="p-3 text-yellow-400">Accuracy</th>
                                <th class="p-3">Precision</th>
                                <th class="p-3">Recall</th>
                                <th class="p-3">F1 Score</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody" class="text-gray-300">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Augmentation Preview -->
            <section class="bg-gray-900 p-6 rounded-lg border border-gray-800 shadow-lg">
                <h2 class="text-xl mb-4 text-purple-400 font-mono">>_ Dataset Augmentation Preview</h2>
                <div class="flex items-center space-x-4 mb-4">
                    <input type="file" id="augInput"
                        class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer" />
                    <button onclick="previewAugmentation()"
                        class="px-6 py-2 border border-purple-500 text-purple-400 rounded font-bold hover:bg-purple-900 transition">GENERATE
                        PREVIEWS</button>
                </div>

                <div id="augResults" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
                    <div class="bg-black p-2 rounded border border-gray-700">
                        <p class="text-xs text-center text-gray-500 mb-2">ROTATED 90°</p>
                        <img id="img-rotated" class="w-full h-40 object-cover rounded border border-gray-800" />
                    </div>
                    <div class="bg-black p-2 rounded border border-gray-700">
                        <p class="text-xs text-center text-gray-500 mb-2">FLIPPED HORIZONTALLY</p>
                        <img id="img-flipped" class="w-full h-40 object-cover rounded border border-gray-800" />
                    </div>
                    <div class="bg-black p-2 rounded border border-gray-700">
                        <p class="text-xs text-center text-gray-500 mb-2">BRIGHTNESS SHIFT (1.5x)</p>
                        <img id="img-brightness" class="w-full h-40 object-cover rounded border border-gray-800" />
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        window.addEventListener('load', () => {
            document.getElementById('loader').style.display = 'none';
            document.body.style.display = 'block';
            loadLeaderboard(); // Load data on startup
        });

        function switchTab(tab) {
            ['predict', 'change', 'training', 'analysis'].forEach(t => {
                document.getElementById('view-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).className = "tab-inactive pb-1 hover:text-white cursor-pointer";
            });
            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).className = "tab-active pb-1 cursor-pointer";
        }

        // --- PREDICTION LOGIC ---
        async function processUpload() {
            const fileInput = document.getElementById('imageInput');
            const files = fileInput.files;
            if (files.length === 0) return alert("Select images first");
            const formData = new FormData();
            document.getElementById('singleResult').classList.add('hidden');
            document.getElementById('batchResult').classList.add('hidden');

            try {
                if (files.length === 1) {
                    formData.append('file', files[0]);
                    const res = await fetch('/classification/predict', { method: 'POST', body: formData });
                    const data = await res.json();
                    document.getElementById('singleResult').classList.remove('hidden');
                    document.getElementById('mainLabel').innerText = data.prediction;
                    document.getElementById('confidence').innerText = "Confidence: " + data.confidence;
                    let html = "";
                    for (const [cls, val] of Object.entries(data.breakdown)) {
                        html += `<div class="mb-2"><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">${cls}</span><span class="text-yellow-400 font-bold">${val}%</span></div><div class="w-full bg-gray-900 h-1.5 rounded-full overflow-hidden"><div class="bg-purple-600 h-full" style="width: ${val}%"></div></div></div>`;
                    }
                    document.getElementById('distribution').innerHTML = html;
                } else {
                    for (let i = 0; i < files.length; i++) formData.append('files', files[i]);
                    const res = await fetch('/classification/predict-batch', { method: 'POST', body: formData });
                    const data = await res.json();
                    document.getElementById('batchResult').classList.remove('hidden');
                    document.getElementById('batchTotal').innerText = `${data.stats.total_processed} Images Analyzed`;
                    let html = "";
                    for (const [cls, count] of Object.entries(data.stats.distribution)) {
                        html += `<div class="bg-gray-900 p-4 rounded text-center border border-gray-800"><span class="text-gray-500 text-[10px] uppercase block mb-1">${cls}</span><span class="text-purple-400 text-2xl font-bold">${count}</span></div>`;
                    }
                    document.getElementById('batchStats').innerHTML = html;
                }
            } catch (err) { console.error(err); alert("Processing failed"); }
        }

        // --- CHANGE DETECTION LOGIC ---
        async function processChangeDetection() {
            const f1 = document.getElementById('file1').files[0];
            const f2 = document.getElementById('file2').files[0];
            if (!f1 || !f2) return alert("Upload both images");
            const formData = new FormData();
            formData.append('file1', f1);
            formData.append('file2', f2);
            try {
                const res = await fetch('/classification/change-detection', { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('changeResult').classList.remove('hidden');
                let rows = "";
                data.report.area_stats.forEach(stat => {
                    const trendColor = stat.trend === 'increasing' ? 'text-red-400' : 'text-green-400';
                    rows += `<tr class="border-b border-gray-800 hover:bg-gray-900 transition"><td class="p-3 font-bold text-gray-300">${stat.class}</td><td class="p-3">${stat.year1_area_km2}</td><td class="p-3">${stat.year2_area_km2}</td><td class="p-3 ${trendColor} font-bold">${stat.change_pct}</td></tr>`;
                });
                document.getElementById('changeTableBody').innerHTML = rows;
            } catch (err) { console.error(err); alert("Analysis Error"); }
        }

        // --- TRAINING LOGIC ---
        let accChart, lossChart;
        function initCharts() {
            if (accChart) accChart.destroy();
            if (lossChart) lossChart.destroy();
            const commonOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#222' } }, y: { grid: { color: '#222' } } } };

            accChart = new Chart(document.getElementById('accChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#a855f7', tension: 0.3 }] }, options: commonOpts });
            lossChart = new Chart(document.getElementById('lossChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#facc15', tension: 0.3 }] }, options: commonOpts });
        }

        function startTraining() {
            initCharts();
            const logs = document.getElementById('trainingLogs');
            logs.innerHTML = '<div class="text-blue-400">>> ESTABLISHING CONNECTION...</div>';
            document.getElementById('trainBtn').disabled = true;
            document.getElementById('trainBtn').innerText = "TRAINING...";

            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const ws = new WebSocket(`${protocol}://${window.location.host}/training/ws/start`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.status === "complete") {
                    logs.innerHTML += `<div class="text-green-400 mt-2">>> ${data.message}</div>`;
                    document.getElementById('trainBtn').disabled = false;
                    document.getElementById('trainBtn').innerText = "INITIALIZE TRAINING RUN";
                    return;
                }
                accChart.data.labels.push(data.epoch); accChart.data.datasets[0].data.push(data.accuracy); accChart.update('none');
                lossChart.data.labels.push(data.epoch); lossChart.data.datasets[0].data.push(data.loss); lossChart.update('none');
                logs.innerHTML += `<div class="text-gray-300">> ${data.log}</div>`;
                logs.scrollTop = logs.scrollHeight;
                document.getElementById('gpuStatus').innerText = `GPU LOAD: ${data.gpu_util}%`;
            };
        }

        // --- ANALYSIS LOGIC (NEW) ---
        async function loadLeaderboard() {
            try {
                const res = await fetch('/classification/leaderboard');
                const data = await res.json();
                let html = "";
                data.leaderboard.forEach(m => {
                    html += `<tr class="border-b border-gray-800 hover:bg-gray-900 transition"><td class="p-3 font-bold text-gray-300">${m.model}</td><td class="p-3 text-yellow-400 font-bold">${m.accuracy}</td><td class="p-3">${m.precision}</td><td class="p-3">${m.recall}</td><td class="p-3">${m.f1}</td></tr>`;
                });
                document.getElementById('leaderboardBody').innerHTML = html;
            } catch (e) { console.error("Leaderboard error", e); }
        }

        async function previewAugmentation() {
                const file = document.getElementById('augInput').files[0];
                if (!file) return alert("Select an image first");
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/classification/augment-preview', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (Object.keys(data.images).length === 0) {
                        alert("Backend failed to process image. Check server logs.");
                        return;
                    }

                    document.getElementById('augResults').classList.remove('hidden');

                    // Changed to image/png
                    document.getElementById('img-rotated').src = "data:image/png;base64," + data.images.rotated;
                    document.getElementById('img-flipped').src = "data:image/png;base64," + data.images.flipped;
                    document.getElementById('img-brightness').src = "data:image/png;base64," + data.images.brightness;
                } catch (e) {
                    console.error(e);
                    alert("Augmentation failed. Ensure you are uploading a valid image file.");
                }
            }
    </script>
</body>

</html>